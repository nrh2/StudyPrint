{% extends "worksheet_base.html" %}

{% block content %}

<!-- ============ CSV 取り込み ============ -->
<section class="card">
    <h2>CSVファイルから取り込む</h2>
    <form id="csvForm" action="{{ url_for('narabikae.index') }}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="action" value="csv_load">
        <label class="form-label">CSVファイルを選択：</label>
        <input class="form-input" type="file" name="csv_file" accept=".csv" onchange="document.getElementById('csvForm').submit();">
    </form>

    {% if filename %}
        <!-- CSV情報リセット -->
        <form action="{{ url_for('narabikae.index') }}" method="post">
            <input type="hidden" name="action" value="csv_reset">
            <button class="button" type="submit" onclick="return confirm('CSV情報をリセットしますか？')">CSV情報リセット</button>
        </form>

    {% else %}
        <!-- CSV情報作成 -->
        <button class="button" type="button" id="openManualBtn">CSV情報作成</button>

    {% endif %}

    {% if filename %}
        <p>選択中のファイル：{{ filename }}</p>
    {% else %}
        <p>CSVファイルが選択されていません。</p>
    {% endif %}
</section>

<hr>

<!-- ============ 手入力 / 情報更新ダイアログ起動 ============ -->
<section class="card">
    <h2>CSVファイル情報更新</h2>
    {% if filename %}
        <p>下記ボタンからCSVファイルの情報を更新できます。</p>
        <button class="button" type="button" id="openManualBtn">情報更新</button>
    {% else %}
        <p>「CSV情報作成」ボタンからジャンルとことばを入力してください。</p>
    {% endif %}
</section>

<!-- ============ 手入力モーダル ============ -->
<div class="modal" id="manualModal" aria-hidden="true" style="display:none;">
    <div class="modal__backdrop" id="manualBackdrop"></div>

    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="manualModalTitle">
        <div class="modal__header">
            {% if filename %}
                <h3 id="manualModalTitle">ジャンルと使用することばを修正、または追加してください</h3>
            {% else %}
                <h3 id="manualModalTitle">ジャンルと使用することばを入力してください</h3>
            {% endif %}
        </div>

        <div class="modal__body">
            <form id="manualForm" action="{{ url_for('narabikae.index') }}" method="post">
                <input type="hidden" name="action" value="manual_save">

                <label class="form-label" for="genre">ジャンル名：</label>
                {% if filename %}
                    <input class="form-input" id="genre" name="genre" type="text"
                        value="{{ genre }}">
                {% else %}
                    <input class="form-input" id="genre" name="genre" type="text"
                        value="{{ genre|default('') }}">
                {% endif %}
                        <br><br>

                <label class="form-label">ことば入力</label>
                <br>
                {# 単語入力ボックス（初期5個） #}
                {% set word_box_cnt = default_manual_input_count %}
                {% for i in range(word_box_cnt) %}
                    <label class="form-label" for="word_{{ i }}">{{ i+1 }}</label>
                    {% if filename %}
                        <input class="form-input" id="word_{{ i }}" name="words" type="text"
                        value="{{ words[i] if words and i < words|length else '' }}">
                    {% else %}
                        <input class="form-input" id="word_{{ i }}" name="words" type="text"
                        value="{{ words[i] if words and i < words|length else '' }}">
                    {% endif %}
                    <br>
                {% endfor %}

                <br>
                <div class="modal__footer">
                    <button class="button button--primary" type="submit" id="saveManualBtn">保存</button>
                    <button class="button" type="button" id="returnManualBtn">戻る</button>
                </div>

            </form>
        </div>
    </div>
</div>

<hr>

<!-- ============ 問題を作成 ============ -->
<section class="card">
    <h2>問題を作成</h2>
    <form action="{{ url_for('narabikae.index') }}" method="post">
        <input type="hidden" name='action' value="generate">

        <label class="form-label">出題数：</label>
        <input class="form-input" type="number" name="question_count"
               value="{{ default_count }}" min="1"><br>

        <label class="form-label">かなモード：</label>
        {% for key, label in kana_modes.items() %}
            <label>
                <input type="radio" name="kana_mode"
                       value="{{ key }}" {% if loop.first %}checked{% endif %}>
                {{ label }}
            </label>
        {% endfor %}

        <br><br>
        <button class="button button--primary" type="submit">問題を作成</button>
    </form>
</section>

<script src="{{ url_for('static', filename='hand_writing_modal.js') }}"></script>
{% endblock %}
